name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'LICENSE'
      - '.gitignore'
  pull_request:
    branches:
      - main
      - develop
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'LICENSE'
      - '.gitignore'
  workflow_dispatch:

# Cancel in-progress runs when a new run is triggered
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  DOTNET_VERSION: '10.0.x'
  BUILD_CONFIGURATION: 'Release'

jobs:
  # ============================================================
  # Build and Test
  # ============================================================
  build:
    runs-on: ubuntu-latest
    name: Build & Test

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore

      - name: Build solution
        run: dotnet build --configuration ${{ env.BUILD_CONFIGURATION }} --no-restore

      - name: Run unit tests
        run: dotnet test --configuration ${{ env.BUILD_CONFIGURATION }} --no-build --logger "trx;LogFileName=test-results.trx" --collect:"XPlat Code Coverage"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: test-results
          path: '**/test-results.trx'

      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: coverage-reports
          path: '**/coverage.cobertura.xml'

      - name: Check code coverage
        run: |
          echo "Code coverage metrics:"
          find . -name "coverage.cobertura.xml" -exec echo "Found: {}" \;

  # ============================================================
  # Code Quality Checks
  # ============================================================
  code-quality:
    runs-on: ubuntu-latest
    name: Code Quality

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore

      - name: Run analyzers
        run: dotnet build --configuration ${{ env.BUILD_CONFIGURATION }} --no-restore /p:TreatWarningsAsErrors=true
        continue-on-error: true

      - name: Check formatting
        run: dotnet format --verify-no-changes --verbosity diagnostic
        continue-on-error: true

  # ============================================================
  # Benchmark Results
  # ============================================================
  benchmarks:
    runs-on: ubuntu-latest
    name: Performance Benchmarks
    # Skip benchmarks for Dependabot PRs and only run on main branch pushes from real commits
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && github.actor != 'dependabot[bot]'

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore

      - name: Build benchmark runner
        run: dotnet build --configuration Release tests/Clywell.Core.Logging.BenchmarkRunner/Clywell.Core.Logging.BenchmarkRunner.csproj --no-restore

      - name: Run benchmarks (LogMessages)
        run: dotnet run -c Release -- --filter "*LogMessagesBenchmarks*" --exporters json
        working-directory: tests/Clywell.Core.Logging.BenchmarkRunner
        timeout-minutes: 30
        continue-on-error: true

      - name: Run benchmarks (LoggerScopes)
        run: dotnet run -c Release -- --filter "*LoggerScopeExtensionsBenchmarks*" --exporters json
        working-directory: tests/Clywell.Core.Logging.BenchmarkRunner
        timeout-minutes: 30
        continue-on-error: true

      - name: Run benchmarks (SensitiveDataRedaction)
        run: dotnet run -c Release -- --filter "*SensitiveDataRedactionBenchmarks*" --exporters json
        working-directory: tests/Clywell.Core.Logging.BenchmarkRunner
        timeout-minutes: 30
        continue-on-error: true

      - name: Upload benchmark results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: benchmark-results
          path: '**/BenchmarkDotNet.Artifacts/'

      - name: Comment benchmark results on PR
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Find benchmark results
            const resultsDir = './tests/Clywell.Core.Logging.BenchmarkRunner/BenchmarkDotNet.Artifacts/results';
            if (fs.existsSync(resultsDir)) {
              const files = fs.readdirSync(resultsDir);
              const jsonFile = files.find(f => f.endsWith('.json'));
              
              if (jsonFile) {
                const results = JSON.parse(fs.readFileSync(path.join(resultsDir, jsonFile), 'utf8'));
                
                let comment = '## üìä Benchmark Results\n\n';
                comment += '**Summary:**\n';
                comment += `- Total benchmarks: ${results.length}\n`;
                
                github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: comment
                });
              }
            }
        continue-on-error: true

  # ============================================================
  # Build Documentation
  # ============================================================
  documentation:
    runs-on: ubuntu-latest
    name: Documentation Check
    # Skip for Dependabot - they don't modify docs
    if: github.actor != 'dependabot[bot]'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Check README files
        run: |
          echo "Checking documentation files..."
          test -f README.md && echo "‚úì Main README found" || echo "‚úó Main README missing"
          test -f docs/INDEX.md && echo "‚úì Documentation index found" || echo "‚úó Documentation index missing"
          test -f tests/Clywell.Core.Logging.Tests/Benchmarks/README.md && echo "‚úì Benchmark README found" || echo "‚úó Benchmark README missing"
          test -f tests/Clywell.Core.Logging.BenchmarkRunner/README.md && echo "‚úì Benchmark runner README found" || echo "‚úó Benchmark runner README missing"

  # ============================================================
  # Publish Results
  # ============================================================
  publish-test-results:
    runs-on: ubuntu-latest
    name: Publish Test Results
    if: always()
    needs: [build]

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v7
        with:
          path: artifacts

      - name: Publish test results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: 'artifacts/**/*.trx'
          check_name: Test Results
        continue-on-error: true

      - name: Generate coverage badge
        run: |
          echo "Coverage badge generation would go here"
          echo "Integration with codecov.io can be added"
        continue-on-error: true

  # ============================================================
  # Summary
  # ============================================================
  summary:
    runs-on: ubuntu-latest
    name: CI/CD Summary
    if: always()
    needs: [build, code-quality, documentation]

    steps:
      - name: Check job status
        run: |
          echo "CI/CD Pipeline Summary:"
          echo "=======================";
          echo "Build: ${{ job.status }}"
          echo "Code Quality: ${{ needs.code-quality.result }}"
          echo "Documentation: ${{ needs.documentation.result }}"
          echo "=======================";
          
          if [ "${{ job.status }}" == "failure" ]; then
            echo "‚ö†Ô∏è  Some jobs failed. Please review the logs."
            exit 1
          else
            echo "‚úì All jobs passed!"
          fi
